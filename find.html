<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbxtmz0CoI5iva6whiEXgRw5IMA1MRYj2-4y9E7DXLtWccCYRmhq3G1bFFDpXeKqRkjPWw/exec';

  let fullData = [];

  // Initial fetch for populating dropdowns
  fetch(`${scriptURL}?address=ping`)
    .then(res => res.json())
    .then(json => {
      fullData = json.filter(r => r.State && r.City);
      const states = [...new Set(fullData.map(r => r.State))].sort();
      const stateSelect = document.getElementById('stateSelect');
      stateSelect.innerHTML = '<option value="">--Select State--</option>';
      states.forEach(state => {
        const opt = document.createElement('option');
        opt.value = state;
        opt.textContent = state;
        stateSelect.appendChild(opt);
      });
    });

  function toggleDisclaimer() {
    const d = document.getElementById("disclaimerText");
    d.style.display = d.style.display === "none" ? "block" : "none";
  }

  function agreeDisclaimer() {
    localStorage.setItem("disclaimerAccepted", "true");
    document.getElementById("disclaimerText").style.display = "none";
    document.getElementById("searchOptions").style.display = "block";
  }

  window.onload = () => {
    if (localStorage.getItem("disclaimerAccepted") === "true") {
      document.getElementById("searchOptions").style.display = "block";
    }
  };

  function populateCities() {
    const selectedState = document.getElementById('stateSelect').value;
    const cities = [...new Set(fullData.filter(r => r.State === selectedState).map(r => r.City))].sort();
    const citySelect = document.getElementById('citySelect');
    citySelect.innerHTML = '<option value="">--Select City--</option>';
    cities.forEach(city => {
      const opt = document.createElement('option');
      opt.value = city;
      opt.textContent = city;
      citySelect.appendChild(opt);
    });
    document.getElementById('stateCityResults').innerHTML = '';
  }

  function showResults() {
    const state = document.getElementById('stateSelect').value;
    const city = document.getElementById('citySelect').value;
    const filtered = fullData.filter(r => r.State === state && r.City === city);
    const resultDiv = document.getElementById('stateCityResults');
    resultDiv.innerHTML = filtered.map(r =>
      `<div><strong>${r["Full Name"]}</strong> – ${r["Phone"]}</div>`
    ).join('<br><br>');
  }

  function handleSearchMethodChange() {
    const value = document.getElementById('searchMethod').value;
    if (!value) return;
    document.getElementById("noticeBanner").style.display = "block";
    const sections = document.getElementsByClassName('section');
    for (let i = 0; i < sections.length; i++) {
      sections[i].style.display = 'none';
    }
    document.getElementById(value).style.display = 'block';
  }

  async function findByGPS() {
    const output = document.getElementById("gpsOutput");
    output.innerHTML = "Locating you...";
    if (!navigator.geolocation) {
      output.innerHTML = "Your browser does not support GPS location.";
      return;
    }
    navigator.geolocation.getCurrentPosition(async position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const url = `${scriptURL}?lat=${lat}&lng=${lng}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.length === 0) {
          output.innerHTML = "No relocators found near you.";
        } else {
          output.innerHTML = data.map(r =>
            `<div><strong>${r["Full Name"]}</strong> – ${r["Phone"]}<br><small>${typeof r["Distance"] === "number" ? r["Distance"].toFixed(2) : "?"} mi away</small></div>`
          ).join('<br><br>');
        }
      } catch (err) {
        output.innerHTML = "Error retrieving data. Please try again later.";
      }
    }, () => {
      output.innerHTML = "GPS access was denied or not available.";
    });
  }

  async function findByAddress() {
    const output = document.getElementById("addressOutput");
    const address = document.getElementById("addressInput").value.trim();
    if (!address) {
      output.innerHTML = "Please enter a full address.";
      return;
    }
    output.innerHTML = "Searching...";
    const url = `${scriptURL}?address=${encodeURIComponent(address)}`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      if (!data.length || data.error) {
        output.innerHTML = "No relocators found or address could not be located.";
      } else {
        output.innerHTML = data.map(r =>
          `<div><strong>${r["Full Name"]}</strong> – ${r["Phone"]}<br><small>${typeof r["Distance"] === "number" ? r["Distance"].toFixed(2) : "?"} mi away</small></div>`
        ).join('<br><br>');
      }
    } catch (err) {
      output.innerHTML = "Error retrieving data. Please try again later.";
    }
  }
</script>
