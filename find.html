<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Find a Snake Relocator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f8f4; margin: 0; }
    h1, h2 { color: #2d593f; }
    input, select, button { padding: 8px; margin: 5px 0 15px; width: 100%; max-width: 400px; }
    button { background-color: #336633; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #2a552a; }
    .section { margin-bottom: 40px; }
    .results { margin-top: 15px; padding: 10px; background: #fff; border-radius: 6px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .card { padding: 10px; border-radius: 6px; border: 1px solid #e6e6e6; margin-bottom: 10px; }
    .card strong { color: #1e3a27; }
    .muted { color: #555; font-size: 0.9rem; }
    iframe { width: 100%; height: 800px; border: none; border-radius: 8px; }
    small { color: #555; }
    .disclaimer-link { font-size: 0.95rem; margin-bottom: 10px; display: block; color: #225533; cursor: pointer; text-decoration: underline; }
    .disclaimer-box { display: none; background-color: #fff8e1; border: 1px solid #d6b700; padding: 15px; margin: 20px 0; border-radius: 6px; color: #333; }
    .disclaimer-box button { margin-top: 10px; background-color: #225533; }
    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn-row button { width: auto; }
  </style>
</head>
<body>
  <h1>Find a Snake Relocator</h1>

  <a class="disclaimer-link" onclick="toggleDisclaimer()">ðŸ“œ Read Disclaimer</a>
  <div id="disclaimerBox" class="disclaimer-box">
    <p><strong>DISCLAIMER:</strong> This directory is provided as a public service to help connect individuals with local snake relocation volunteers. FreeSnakeRelocation.com does not verify the identity, background, or certifications of any volunteers listed. All volunteers operate independently, and it is your responsibility to determine whether someone is qualified or trustworthy. If you do not feel comfortable using this service, please do not proceed and instead contact local animal control or wildlife authorities.</p>
    <button onclick="toggleDisclaimer()">Close</button>
  </div>

  <!-- Find by Address / GPS -->
  <div class="section">
    <h2>Find the 3 Closest by Address or GPS</h2>
    <label for="addrInput">Enter address (or city & state)</label>
    <input id="addrInput" type="text" placeholder="e.g., 123 Main St, Chesapeake, VA" />
    <div class="btn-row">
      <button onclick="findByAddress()">Find by Address</button>
      <button onclick="findByGPS()">Use My Location</button>
    </div>
    <div id="nearestResults" class="results"></div>
    <small class="muted">Weâ€™ll only show the closest 3 volunteers and their approximate distance.</small>
  </div>

  <!-- Search by State & City -->
  <div class="section">
    <h2>Search by State & City</h2>
    <label for="stateSelect">Select State</label>
    <select id="stateSelect" onchange="populateCities()">
      <option value="">--Select State--</option>
    </select>

    <label for="citySelect">Select City</label>
    <select id="citySelect" onchange="showResults()">
      <option value="">--Select City--</option>
    </select>

    <div id="stateCityResults" class="results"></div>
  </div>

  <!-- Map Section -->
  <div class="section">
    <h2>View Relocators on the Map</h2>
    <iframe src="https://www.google.com/maps/d/embed?mid=1__R7DSwXpME1vtvTbOTOBlZXV6CsO3w" allowfullscreen></iframe>
  </div>

  <script>
    // ======== CONFIG ========
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyiC9sfiliUOjv9_liFC_Ex2IgAzNLmhGS-6-oiZXVdLQKLmWyy0HgtFM2rcBcy1Szyww/exec';

    let data = [];

    // -------- JSONP loader (bypasses CORS) --------
    function loadJSONP(url, callbackName) {
      return new Promise((resolve, reject) => {
        const cb = `__jsonp_${callbackName}_${Date.now()}`;
        window[cb] = (payload) => {
          try { resolve(payload); } finally {
            delete window[cb];
            script.remove();
          }
        };
        const script = document.createElement('script');
        script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        script.onerror = () => {
          delete window[cb];
          script.remove();
          reject(new Error('JSONP load failed'));
        };
        document.head.appendChild(script);
      });
    }

    // Normalize any server shape to an array of results
    function normalizeResults(d) {
      if (Array.isArray(d)) return d;
      if (d && Array.isArray(d.results)) return d.results;
      if (d && d.error) throw new Error(d.error);
      return [];
    }

    // Load full dataset for state/city (JSONP)
    loadJSONP(`${scriptURL}?mode=full&t=${Date.now()}`, 'full')
      .then(json => {
        const rows = normalizeResults(json);
        data = rows.filter(r => r.State && r.City);
        const states = [...new Set(data.map(r => r.State))].sort();
        const stateSelect = document.getElementById('stateSelect');
        states.forEach(state => {
          const opt = document.createElement('option');
          opt.value = state;
          opt.textContent = state;
          stateSelect.appendChild(opt);
        });
      })
      .catch(() => { /* silent */ });

    // Find Closest by Address (JSONP)
    async function findByAddress() {
      const addr = document.getElementById('addrInput').value.trim();
      const container = document.getElementById('nearestResults');
      container.innerHTML = '';
      if (!addr) {
        container.innerHTML = "<em>Please enter an address.</em>";
        return;
      }
      container.innerHTML = "Searching for nearest relocatorsâ€¦";
      try {
        const json = await loadJSONP(`${scriptURL}?address=${encodeURIComponent(addr)}&t=${Date.now()}`, 'nearestAddr');
        const results = normalizeResults(json);
        if (!results.length) {
          container.innerHTML = `<em>No nearby relocators found for "${sanitize(addr)}". Try a city & state (e.g., "Chesapeake, VA").</em>`;
          return;
        }
        renderNearest(results);
      } catch (err) {
        container.innerHTML = `<em>Sorry, we couldnâ€™t find results for that address. (${String(err).replace(/</g,'&lt;')})</em>`;
      }
    }

    // Find Closest by GPS (JSONP)
    function findByGPS() {
      const container = document.getElementById('nearestResults');
      container.innerHTML = '';
      if (!navigator.geolocation) {
        container.innerHTML = "<em>Your browser doesnâ€™t support GPS location.</em>";
        return;
      }
      container.innerHTML = "Getting your locationâ€¦";
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const { latitude, longitude } = pos.coords;
        try {
          const json = await loadJSONP(`${scriptURL}?lat=${latitude}&lng=${longitude}&t=${Date.now()}`, 'nearestGPS');
          const results = normalizeResults(json);
          if (!results.length) {
            container.innerHTML = "<em>No nearby relocators found from your location.</em>";
            return;
          }
          renderNearest(results);
        } catch (err) {
          container.innerHTML = `<em>Sorry, we couldnâ€™t find results from your location. (${String(err).replace(/</g,'&lt;')})</em>`;
        }
      }, () => {
        container.innerHTML = "<em>We couldnâ€™t access your location. Try typing an address instead.</em>";
      }, { enableHighAccuracy: true, timeout: 10000 });
    }

    // Render top-3 cards
    function renderNearest(list) {
      const container = document.getElementById('nearestResults');
      if (!Array.isArray(list) || list.length === 0) {
        container.innerHTML = "<em>No nearby relocators found.</em>";
        return;
      }
      container.innerHTML = list.map(r => {
        const dist = r.DistanceMiles != null ? `${Number(r.DistanceMiles).toFixed(1)} mi away` : '';
        const phone = r.Phone ? `<a href="tel:${r.Phone.replace(/[^0-9+]/g,'')}">${sanitize(r.Phone)}</a>` : '';
        const place = [r.City, r.State].filter(Boolean).join(', ');
        return `
          <div class="card">
            <div><strong>${sanitize(r["Full Name"] || r.Name || "Volunteer")}</strong></div>
            <div>${phone}</div>
            <div class="muted">${sanitize(place)} ${dist ? ' Â· ' + dist : ''}</div>
          </div>`;
      }).join('');
    }

    // State/City helpers
    function populateCities() {
      const selectedState = document.getElementById('stateSelect').value;
      const cities = [...new Set(data.filter(r => r.State === selectedState).map(r => r.City))].sort();
      const citySelect = document.getElementById('citySelect');
      citySelect.innerHTML = '<option value="">--Select City--</option>';
      cities.forEach(city => {
        const opt = document.createElement('option');
        opt.value = city;
        opt.textContent = city;
        citySelect.appendChild(opt);
      });
      document.getElementById('stateCityResults').innerHTML = '';
    }

    function showResults() {
      const state = document.getElementById('stateSelect').value;
      const city = document.getElementById('citySelect').value;
      const filtered = data.filter(r => r.State === state && r.City === city);
      const resultDiv = document.getElementById('stateCityResults');
      resultDiv.innerHTML = filtered.length
        ? filtered.map(r =>
            `<div><strong>${sanitize(r["Full Name"] || r.Name || "Volunteer")}</strong> â€“ ${sanitize(r["Phone"] || "")}` +
            (r["Distance"] ? `<br><small>${sanitize(r["Distance"])} mi away</small>` : '') +
            `</div>`
          ).join('<br><br>')
        : "<em>No relocators found for this city.</em>";
    }

    function toggleDisclaimer() {
      const box = document.getElementById("disclaimerBox");
      box.style.display = box.style.display === "none" ? "block" : "none";
    }

    // Sanitize to avoid HTML injection
    function sanitize(str) {
      return String(str || '').replace(/[&<>"']/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[s]));
    }
  </script>
</body>
</html>
